---
title: "rough work"
author: "Sciper 359523"
date: "2023-05-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r working directory and data, echo=FALSE, include=FALSE}
lapply(c("dplyr","chron","ggplot2","tidyr","questionr","survival","forcats","tidyselect",
         "data.table","table1","lubridate", "ggpubr","viridis","finalfit","survminer",
         "ggpubr", "ggthemes", "gridExtra", "rstatix","stringr",
         "wesanderson","kableExtra", "naniar","boot","scales","ggsci", "stringr",
         "Hmisc","DescTools","swimplot", 'stats', 'EnvStats', 'finalfit'), 
       library, character.only=TRUE)

set.seed(435) #set the seed for reproducible results

#data <- read.csv('data.csv', header=T)
#data_2 <- read.csv('data_2.csv', header=T)
data <- read.csv('owid-covid-data.csv', header = T)
```


# modify the data 
link : https://github.com/owid/covid-19-data/tree/master/public/data
https://ourworldindata.org/coronavirus

```{r}
data <- data %>% filter(continent == 'Europe')

gg_miss_fct(x = data, fct = location)#to see where data is missing 

forbidden <- c('England', 'Scotland', 'Northern Ireland', 'Wales')
data <- subset(data, !(data$location %in% forbidden))

variables_to_keep <- c('location', 'date', 'total_cases', 'new_cases', 'total_cases_per_million', 'new_cases_per_million', 'stringency_index', 'population_density', 'median_age', 'aged_65_older', 'aged_70_older', 'gdp_per_capita', 'extreme_poverty', 'cardiovasc_death_rate', 'diabetes_prevalence', 'female_smokers', 'male_smokers', 'hospital_beds_per_thousand', 'life_expectancy', 'human_development_index', 'population', 'excess_mortality_cumulative_absolute', 'excess_mortality', 'excess_mortality_cumulative_per_million', 'excess_mortality_cumulative')

df <- data[,variables_to_keep]
gg_miss_fct(x = df, fct = location)

#some countries still have lots of missing data so we don't take them 
forbidden <- c('Andorra', 'Faeroe Islands', 'Gibraltar', 'Guernsey', 'Isle of Man', 'Jersey', 'Kosovo', 'Liechtenstein', 'Monaco', 'San Marino', 'Vatican')
df <- subset(df, !(df$location %in% forbidden)) #the data is way better

df <- df %>% mutate(
  date = as.Date(date, format = "%Y-%m-%d")
) 

```


# descriptive statistics 
visualisation des cas 
```{r}
df%>% ggplot(aes(x=date, y=total_cases, color=location)) + geom_line()

df%>% ggplot(aes(x=date, y=new_cases, color=location)) + geom_line()

df%>% ggplot(aes(x=date, y=total_cases_per_million, color=location)) + geom_line()

df%>% ggplot(aes(x=date, y=new_cases_per_million, color=location)) + geom_line()

df <- df %>% mutate(
  log_total_cases = log(total_cases),
  log_total_cases_per_million = log(total_cases_per_million)
)

df%>% ggplot(aes(x=date, y=log_total_cases_per_million, color=location)) + geom_line()
``` 

# smoothing with rolling mean
rolling mean of 7 (weekly reporting pb)
```{r}
library(cowplot)
library(zoo)
#roll <- rollmean(df$log_total_cases_per_million, k=7, align = 'right', fill = NA)

df <- df %>% mutate(
  roll_log_cases_per_million = rollmean(log_total_cases_per_million, k=7, align = 'right', fill = NA),
  roll_new_cases_per_million = rollmean(new_cases_per_million, k=7, align = 'right', fill = NA)
)

df%>% ggplot(aes(x=date, y=roll_log_cases_per_million, color=location)) + geom_line()

df%>% ggplot(aes(x=date, y=roll_new_cases_per_million, color=location)) + geom_line()
```


# smoothing with kernel 
bandwith of 7 since we know there were problems in cases reporting during the week-ends, so we smooth over this window
```{r}
countries <- unique(df$location)

#calcule le smoothed pour chaque 
test <- df %>% filter(location == countries[1])
smoothed = ksmooth(test$date, test$total_cases_per_million, bandwidth = 7)
test$smoothed_cases_per_million <- smoothed$y
smoothed = ksmooth(test$date, test$log_total_cases_per_million, bandwidth = 7)
test$log_smoothed_cases_per_million <- smoothed$y
data_frame <- test

countries <- countries[2:length(countries)]

for (country in countries){
  test <- df %>% filter(location == country)
  smoothed = ksmooth(test$date, test$total_cases, bandwidth = 7)
  test$smoothed_cases_per_million <- smoothed$y
  smoothed = ksmooth(test$date, test$log_total_cases_per_million, bandwidth = 7)
  test$log_smoothed_cases_per_million <- smoothed$y
  data_frame <- bind_rows(data_frame,test)
}

data_frame%>% ggplot(aes(x=date, y=smoothed_cases_per_million, color=location)) + geom_line()

data_frame%>% ggplot(aes(x=date, y=log_smoothed_cases_per_million, color=location)) + geom_line()

```


# PCA avec juste les pays, pas de variable en plus, et pas de registration 
on fait un dataset 
```{r}
col = c('date', 'log_smoothed_cases_per_million', 'location')
data_pca <- data_frame[,col]
data_pca <- pivot_wider(data_pca, names_from = location, values_from = log_smoothed_cases_per_million)
gg_miss_fct(x = data_pca, fct = date) #on a un intervalle sans données manquantes 

#on enlève les données manquantes
data_pca <- na.omit(data_pca)
data_pca <- data_pca[,2:41]

matrix_pca <- data.matrix(data_pca)
```


pca


```{r}
X = t(matrix_pca)

mu <- colMeans(X)
X <- sweep(X,2,mu)

SVD <- svd(X)
Scores <- SVD$u %*% diag(SVD$d)
Loadings <- SVD$v
FVE <- SVD$d^2/sum(SVD$d^2)

par(mfrow = c(3,2))

plot(X[1,]+mu,type="l", ylim=range(X+mu), main="Data and the mean")
for(n in 1:dim(X)[1]) points(X[n,]+mu,type="l")
  points(mu,col=2,lwd=2,type="l")

plot(Scores[1,]*sign(sum(Loadings[,1])), Scores[2,]*sign(sum(Loadings[,2])), main="1st vs 2nd PC scores")


plot(Loadings[,1]*sign(sum(Loadings[,1])),type="l", main=paste0("1st PC (",round(100*FVE[1])," % of var)"))

plot(Loadings[,2]*sign(sum(Loadings[,2])),type="l", main=paste0("2nd PC (",round(100*FVE[2])," % of var)"))
plot(Loadings[,3]*sign(sum(Loadings[,3])),type="l", main=paste0("3rd PC (",round(100*FVE[3])," % of var)"))
plot(Loadings[,4]*sign(sum(Loadings[,4])),type="l", main=paste0("4th PC (",round(100*FVE[4])," % of var)"))


#plot(matrix_pca[,1],type="l")
#for(n in 2:10) points(matrix_pca[,n],type="l",col=n,lty=n%%6+1)
#mu <- colMeans(t(matrix_pca[,1:41]))
#points(mu, type="l", lwd=3)
#legend("topleft", legend="mean curve", lwd=3)

``` 


# Ajout d'autres variables ? 

```{r}
#data_pca
#en ajoutant par ex le gdp per capita 
col = c('location', 'gdp_per_capita')
new_data <- data_frame[,col]
new_data <- new_data%>%group_by(location, gdp_per_capita) %>%summarise()

matrix_test <- t(data.frame(t(new_data)[2,]))
row.names(matrix_test) <- ('gdp_per_capita')
colnames(matrix_test) <- t(new_data)[1,]

matrix_test <- data.frame(matrix_test)
matrix_test <- data.frame(lapply(matrix_test,as.numeric))
colnames(matrix_test) <- names(data_pca)

data_pca_gdp <- bind_rows(data_pca, matrix_test)





#en ajoutant plusieurs variables 
col = c('location', 'gdp_per_capita', 'median_age', 'female_smokers')
new_data <- data_frame[,col]
new_data <- new_data%>%group_by(location, gdp_per_capita, median_age, female_smokers) %>%summarise()

matrix_test <- t(data.frame(t(new_data)[2,], t(new_data)[3,], t(new_data)[4,]))
row.names(matrix_test) <- c('gdp_per_capita', 'median_age', 'female_smokers')
colnames(matrix_test) <- t(new_data)[1,]

matrix_test <- data.frame(matrix_test)
matrix_test <- data.frame(lapply(matrix_test,as.numeric))
colnames(matrix_test) <- names(data_pca)

data_pca_new <- bind_rows(data_pca, matrix_test)

data_pca_new <- na.omit(data_pca_new)

```




```{r}
X = t(data_pca_new)

mu <- colMeans(X)
X <- sweep(X,2,mu)

SVD <- svd(X)
Scores <- SVD$u %*% diag(SVD$d)
Loadings <- SVD$v
FVE <- SVD$d^2/sum(SVD$d^2)

par(mfrow = c(3,2))

plot(X[1,]+mu,type="l", ylim=range(X+mu), main="Data and the mean")
for(n in 1:dim(X)[1]) points(X[n,]+mu,type="l")
  points(mu,col=2,lwd=2,type="l")

plot(Scores[1,]*sign(sum(Loadings[,1])), Scores[2,]*sign(sum(Loadings[,2])), main="1st vs 2nd PC scores")


plot(Loadings[,1]*sign(sum(Loadings[,1])),type="l", main=paste0("1st PC (",round(100*FVE[1])," % of var)"))

plot(Loadings[,2]*sign(sum(Loadings[,2])),type="l", main=paste0("2nd PC (",round(100*FVE[2])," % of var)"))
plot(Loadings[,3]*sign(sum(Loadings[,3])),type="l", main=paste0("3rd PC (",round(100*FVE[3])," % of var)"))
plot(Loadings[,4]*sign(sum(Loadings[,4])),type="l", main=paste0("4th PC (",round(100*FVE[4])," % of var)"))


#plot(matrix_pca[,1],type="l")
#for(n in 2:10) points(matrix_pca[,n],type="l",col=n,lty=n%%6+1)
#mu <- colMeans(t(matrix_pca[,1:41]))
#points(mu, type="l", lwd=3)
#legend("topleft", legend="mean curve", lwd=3)

``` 
































